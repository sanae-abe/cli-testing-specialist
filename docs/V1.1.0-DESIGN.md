# v1.1.0 Design Specification

**Version**: 1.1.0
**Status**: Planning
**Target Release**: 2025-12 (Quality-first, no hard deadline)

---

## üéØ Overview

v1.1.0 focuses on **CI/CD integration** and **practical usability improvements** based on real-world usage with 4 projects (backup-suite, cmdrun, cldev, package-publisher).

### Success Metrics

- **CI Success Rate**: 85-90% ‚Üí 95%+ (target)
- **False Positive Reduction**: Security tests pass on legitimate tools
- **CI Integration Complexity**: Manual setup ‚Üí Single flag (`--ci-mode`)
- **Informational Mode**: Failures don't block CI pipeline

---

## üöÄ Core Features

### 1. CI Integration Mode (`--ci-mode`)

**Problem**:
- Current behavior: Security tests exit with code 1 on any failure
- Impact: Blocks CI pipelines even for informational findings
- User pain: Requires complex CI configuration with `continue-on-error`

**Solution**:
```bash
cli-testing-specialist run tests/ --ci-mode
```

**Behavior**:
- Exit code: Always 0 (warnings only)
- Output format: Markdown summary + JSON details
- Test selection: Security + Input Validation categories only
- Report emphasis: Severity classification (Critical/High/Medium/Low)

**Implementation**:
```rust
// src/cli/commands.rs
#[derive(Parser)]
pub struct RunCommand {
    // ... existing fields ...

    /// CI integration mode: security-focused, informational output, always exit 0
    #[arg(long, conflicts_with = "strict")]
    pub ci_mode: bool,
}

// src/runner/bats_executor.rs
impl BatsExecutor {
    pub fn run_with_ci_mode(&self, test_dir: &Path) -> Result<TestReport> {
        // 1. Filter to security + input-validation categories only
        // 2. Run tests with relaxed timeout (600s instead of 300s)
        // 3. Classify findings by severity
        // 4. Generate markdown summary with actionable recommendations
        // 5. Always return Ok() with full report
    }
}
```

**Exit Codes**:
- Success: 0 (always in CI mode)
- Normal mode: 0 (all passed), 1 (any failed)

---

### 2. Informational Mode (`--informational`)

**Problem**:
- Some tests are exploratory (e.g., detecting dialoguer prompts)
- Failures provide insights but shouldn't block CI
- Current: All-or-nothing (pass/fail)

**Solution**:
```bash
cli-testing-specialist run tests/ --informational
```

**Behavior**:
- Exit code: Always 0
- All test categories run (unlike `--ci-mode`)
- Report format: Same as normal, but emphasizes "Findings" not "Failures"
- Use case: Nightly runs, exploratory testing, documentation

**Difference from `--ci-mode`**:
| Feature | `--ci-mode` | `--informational` |
|---------|-------------|-------------------|
| Exit code | 0 (always) | 0 (always) |
| Test categories | Security + Input Validation only | All categories |
| Primary use case | PR checks, merge gates | Nightly runs, exploration |
| Report focus | Security findings | Comprehensive insights |

---

### 3. Security-Only Mode (`--security-only`)

**Problem**:
- Full test suite takes 2-5 minutes
- Security checks are most critical for CI
- Want faster feedback on security issues

**Solution**:
```bash
cli-testing-specialist run tests/ --security-only
```

**Behavior**:
- Categories: `security`, `input-validation` only
- Exit code: 0 (all passed), 2 (security failed)
- Timeout: 600s (double normal timeout for complex security tests)
- Report: Focused on security findings with remediation advice

**Exit Codes**:
- 0: All security tests passed
- 2: Security tests failed (distinct from general failure code 1)

---

## üìã Secondary Features

### 4. Configuration File Detection

**Problem**:
- Tools like `cmdrun` require `commands.toml` to run
- Current: Manual setup required in CI
- Ideal: Auto-detect and provide template

**Solution**:
```bash
cli-testing-specialist analyze /usr/local/bin/cmdrun -o analysis.json --detect-config
```

**Detection Strategy**:
```rust
// src/analyzer/config_detector.rs
pub struct ConfigDetector {
    pub detected_configs: Vec<ConfigRequirement>,
}

pub struct ConfigRequirement {
    pub option_name: String,        // "--config"
    pub expected_format: FileFormat, // TOML, YAML, JSON
    pub template: Option<String>,    // Generated template content
}

impl ConfigDetector {
    pub fn detect_from_help(&self, help_output: &str) -> Vec<ConfigRequirement> {
        // Regex patterns:
        // --config <FILE>
        // -c, --config-file <PATH>
        // --settings <FILE>
    }

    pub fn generate_template(&self, format: FileFormat) -> String {
        // Generate minimal valid config based on format
    }
}
```

**CI Integration**:
```yaml
# .github/workflows/cli-test.yml
- name: Generate config template
  run: cli-testing-specialist analyze ./target/release/cmdrun --detect-config

- name: Create config file
  run: echo "$CONFIG_TEMPLATE" > commands.toml
```

---

### 5. Interactive UI Detection

**Problem**:
- Tools using `dialoguer`/`inquire` hang in CI
- Current: Manual `--non-interactive` flag or env vars
- Ideal: Auto-detect and suggest workarounds

**Detection Strategy**:
```rust
// src/analyzer/ui_detector.rs
pub struct UiDetector;

impl UiDetector {
    pub fn detect_interactive_deps(&self, project_root: &Path) -> Vec<UiDependency> {
        // 1. Check Cargo.toml for dialoguer, inquire
        // 2. Check package.json for prompts, inquirer
        // 3. Suggest environment variables or flags
    }
}

pub struct UiDependency {
    pub name: String,           // "dialoguer"
    pub version: String,        // "0.10"
    pub workarounds: Vec<Workaround>,
}

pub struct Workaround {
    pub method: WorkaroundMethod, // EnvVar, Flag, Config
    pub value: String,            // "CI=true", "--non-interactive"
    pub confidence: f32,          // 0.0-1.0
}
```

**Report Output**:
```markdown
## ‚ö†Ô∏è Interactive UI Detected

This tool uses `dialoguer` which may hang in CI environments.

**Recommended workarounds**:
1. Set environment variable: `CI=true`
2. Use flag: `--non-interactive` (if available)
3. Provide config file: `config.yml` with `interactive: false`

**Test command**:
```bash
CI=true cli-testing-specialist run tests/
```
```

---

## üîí Security Enhancements

### Exit Code Strategy

**Current**:
- 0: All tests passed
- 1: Any test failed

**v1.1.0**:
- 0: All tests passed
- 1: Non-security tests failed
- 2: Security tests failed (high priority)
- Special: `--ci-mode` and `--informational` always exit 0

**Rationale**:
- Exit code 2 signals critical security issues
- Allows CI to treat security failures differently
- Compatible with `continue-on-error` strategies

---

## üìä Implementation Plan

### Phase 1: Core Modes (Week 1-2)

**Priority: Critical**

1. [ ] Implement `--ci-mode` flag
   - Modify `RunCommand` struct
   - Add `run_with_ci_mode()` method
   - Filter to security categories
   - Always exit 0

2. [ ] Implement `--informational` flag
   - Similar to `--ci-mode` but all categories
   - Enhanced report formatting
   - Always exit 0

3. [ ] Implement `--security-only` flag
   - Filter to security + input-validation
   - Exit code 2 on security failure
   - Increased timeout (600s)

**Testing**:
- Unit tests for each mode
- Integration tests with real tools
- Verify exit codes in all scenarios

---

### Phase 2: Configuration Detection (Week 3)

**Priority: High**

1. [ ] Implement `ConfigDetector`
   - Regex patterns for config options
   - Format detection (TOML/YAML/JSON)
   - Template generation

2. [ ] Add `--detect-config` flag to `analyze` command
   - Output detected requirements to JSON
   - Generate templates in `templates/` dir

3. [ ] Documentation
   - CI integration guide
   - Template usage examples

**Testing**:
- Test with cmdrun, cldev (config-dependent tools)
- Verify template validity

---

### Phase 3: UI Detection (Week 4)

**Priority: Medium**

1. [ ] Implement `UiDetector`
   - Parse Cargo.toml dependencies
   - Parse package.json dependencies
   - Suggest workarounds with confidence scores

2. [ ] Add `--detect-ui` flag to `analyze` command
   - Output to analysis JSON
   - Include in report

3. [ ] Documentation
   - Workaround guide for common UI libraries

**Testing**:
- Test with tools using dialoguer, inquire
- Verify workaround suggestions

---

## üìà Success Criteria

### Functional Requirements

- [ ] `--ci-mode` always exits 0
- [ ] `--informational` runs all categories, exits 0
- [ ] `--security-only` exits 2 on security failure
- [ ] Config detection finds `--config` style options
- [ ] UI detection identifies dialoguer/inquire

### Quality Requirements

- [ ] 95%+ test coverage for new code
- [ ] All clippy warnings resolved
- [ ] Documentation complete (usage examples)
- [ ] Integration tests with 4 real projects

### Performance Requirements

- [ ] `--security-only` runs in <60s (vs 120s+ for full suite)
- [ ] Config detection adds <1s overhead
- [ ] UI detection adds <500ms overhead

---

## üîÑ Migration from v1.0.5

**Breaking Changes**: None (all new features are opt-in flags)

**Recommended CI Updates**:

```yaml
# Before (v1.0.5)
- name: Run CLI tests
  run: cli-testing-specialist run tests/ -f json -o reports/
  continue-on-error: true  # Workaround for strict exit codes

# After (v1.1.0)
- name: Run CLI tests (CI mode)
  run: cli-testing-specialist run tests/ --ci-mode -f json -o reports/
  # No continue-on-error needed, always exits 0

# Or for security-focused PR checks
- name: Security tests
  run: cli-testing-specialist run tests/ --security-only -f json -o reports/
  # Exits 2 on security failure, can fail the build
```

---

## üìù Open Questions

1. **Severity Classification**:
   - How to determine Critical vs High vs Medium?
   - Use CVSS-like scoring or simple heuristics?
   - Decision: Simple heuristics based on test category (security=Critical, input-validation=High, etc.)

2. **Config Template Quality**:
   - How detailed should generated templates be?
   - Include comments/documentation?
   - Decision: Minimal valid config with TODO comments

3. **UI Detection Confidence**:
   - What confidence threshold for workaround suggestions?
   - Show low-confidence suggestions?
   - Decision: Show all with confidence scores, let user decide

---

## üìö References

- **v1.0.5 Test Results**: 4 projects, 68% success rate
- **Common CI Pain Points**: cmdrun config files, dialoguer hangs
- **Industry Standards**: CVSS scoring, exit code conventions
- **Related Issues**: None yet (first feature-driven release)

---

**Last Updated**: 2025-11-12
**Status**: Design phase
**Next Step**: Begin Phase 1 implementation
